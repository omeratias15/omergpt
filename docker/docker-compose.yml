version: "3.9"

services:

  detector:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: omergpt-detector
    restart: always
    environment:
      CUDA_VISIBLE_DEVICES: 0
      PYTHONUNBUFFERED: 1
    command: python3 src/main.py
    volumes:
      - ./data:/workspace/data
      - ./checkpoints:/workspace/checkpoints
      - ./logs:/workspace/logs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "python3", "test_system.py"]
      interval: 3m
      timeout: 30s
      retries: 2

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: omergpt-api
    restart: always
    environment:
      CUDA_VISIBLE_DEVICES: 0
    command: python3 src/api/server.py
    ports:
      - "9000:9000"
    volumes:
      - ./data:/workspace/data
      - ./checkpoints:/workspace/checkpoints
      - ./logs:/workspace/logs
    depends_on:
      - detector
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 1m
      timeout: 15s
      retries: 2

  dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dashboard
    image: omergpt-dashboard
    restart: always
    environment:
      STREAMLIT_SERVER_PORT: 8501
      CUDA_VISIBLE_DEVICES: 0
    command: streamlit run src/system_monitor/dashboard_updater.py --server.port=8501
    ports:
      - "8501:8501"
    volumes:
      - ./data:/workspace/data
      - ./checkpoints:/workspace/checkpoints
      - ./logs:/workspace/logs
      - ./reports:/workspace/reports
    depends_on:
      - detector
      - api
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 2m
      timeout: 30s
      retries: 2

networks:
  default:
    driver: bridge
